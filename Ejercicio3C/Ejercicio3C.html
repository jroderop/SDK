<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Query Múltiple</title>

    <link
    rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/light/main.css" />
     <script src="https://js.arcgis.com/4.34/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script>

    // Cargamos los módulos necesarios para la aplicación web

    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/rest/support/Query",
      "esri/layers/GraphicsLayer"

      ], function (Map, MapView, FeatureLayer, Query, GraphicsLayer) {

        
        // Construimos el objeto mapa
        const map = new Map({
          basemap: "hybrid",
        });

        // Construimos el objeto vista
        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-4, 40], // longitud, latitud
          zoom: 6,
        });


        // Construimos las capas
        const incendiosFL = new FeatureLayer({
          url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/0",
        });
        const paisesMundoFL = new FeatureLayer({
          url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Countries/FeatureServer/0",
        });
        
       
        // Construimos una capa gráfica para guardar los resultados
         const resultadoGL = new GraphicsLayer();


        //Realizo una primera consulta a la capa de paises del mundo para seleccionar España.

        const queryEspaña = new Query({
          where: "ISO_CC = 'ESP'",
          returnGeometry: true,
          outFields: ["COUNTRY"],
          
        });

        paisesMundoFL
          .queryFeatures(queryEspaña) // hay que pasar la query que acabamos de crear
          .then(function (results) {
            
          //  Configuramos la segunda consulta con los resultados de la primera
            results.features.map((poligono) => {

              //Segunda Query, selección de todos los incendios que se encuentren en España y tenga un valor de confidencia mayor de 50

              const queryPoligonos = new Query({
                geometry: poligono.geometry, // el polígono que acabamos de obtener
                spatialRelationship: "contains", // relación espacial
                returnGeometry: true,
                where: "CONFIDENCE > 0" // condición de la consulta       
              });

              // Aplicamos la Query a la capa de incendios
              incendiosFL
                .queryFeatures(queryPoligonos)
                .then(function (results) {
                  // Gestionamos los resultados de la query de incendios
                  results.features.map((entidad) => {
                    // le pasamos una simbología
                    entidad.symbol = {
                      type: "picture-marker",
                      url: "https://cdn-icons-png.flaticon.com/512/1172/1172477.png?w=7",
                      width: "64px",
                      height: "64px",
                      };
                    
                    //añadimos las entidades a la capa gráfica.
                     resultadoGL.add(entidad);
                      
                });
            });
          });
            // Añadimos la capa gráfica al mapa con los resultados
            map.add(resultadoGL);
          })
          .otherwise(function (error) {
            console.log(error);
          });
        });     
      

    </script>
  </head>
  <body>
    <div id="viewDiv"></div>
  </body>
</html>
